define(["sys/template/helpers","sys/template/import","sys/app"],(e,t,n)=>{n.template=((e,...t)=>{let n=[];for(let e=0,i=t.length;e<i;e++){let i=t[e];if("function"==typeof i){let n=i();i=void 0===n||"function"==typeof n?"":n,t[e]=i}i instanceof Promise&&n.push({index:e,sub:i}),"string"!=typeof i&&(t[e]="")}return n.length?(async()=>{for(let e=0,i=n.length;e<i;e++){let i=n[e],a=await i.sub;if("function"==typeof a){let e=a();e instanceof Promise&&(e=await e),a=void 0===e||"function"==typeof e?"":e}t[i.index]="string"!=typeof a?"":a}return String.raw(e,...t)})():String.raw(e,...t)}),n.composite=((e,...t)=>t);const i=(t,n,i)=>((t=t||{}).template||(t.template=e()),i&&(t.template=Object.assign(t.template,i)),t.template.name=n,t),a=(e,t,a,r)=>new Function("return "+n.config.name+".template`"+e+"`;").call(i(t,r,a));return n.parse=(async(e,n,i,r)=>{let o;if("string"==typeof e)o=e;else{let t=(o=e.toString()).indexOf("`",0);if(-1===t)throw new Error("Invalid template");o=o.substring(t+1,o.lastIndexOf("`"))}return await t.parseImportsAsync(o),await a(o,n,i,r)}),{parseTemplate:a,parseComposite:(e,t,a,r)=>new Function("return "+n.config.name+".composite`"+e+"`;").call(i(t,r,a))}});