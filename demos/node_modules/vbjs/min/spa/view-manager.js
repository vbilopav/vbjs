define(["sys/view-manager/utils","sys/view-manager/reveal","sys/app"],(e,{reveal:t,revealComponents:n},i)=>(class{constructor(e=(()=>{throw e})()){this._container=e,this._views={},this._current}leave(e){if(void 0===e)return this;let t=this._views[e];return t?(t.x=window.pageXOffset,t.y=window.pageYOffset,this):this}async reveal({id:s="",view:a=(()=>{throw a})(),params:r={},uri:h=""}){r=await e.prepareParams(r),await new Promise((o,p)=>{let l=this._views[s],d=h.hashCode(),m=e.getId(d);if(this._current&&this._current.hide(),l){if(l.type===e.types.string)return this._current=l.element.show(),e.showView(l,l.element),o(l.element.id);let t=this._container.find("#"+m);if(l.type===e.types.template){if(t.length||(t="span".createElement(m).appendTo(this._container)),l.uriHash!==d){let i=l.instance(r);"string"==typeof i?(t.html(i),e.templateRendered(r,t),n(t,r.template,r)):i instanceof HTMLElement?(t.html("").append(i),e.templateRendered(r,t),n(t,r.template)):i instanceof Promise&&i.then(i=>{"string"==typeof i?t.html(i):t.html("").append(i),e.templateRendered(r,t),n(t,r.template,r)})}return this._current=t.show(),e.showView(l,t),o(t.id)}if(t.length||(t=this._container.find("[data-id='"+s+"']")).length&&(t.id=m),t.length||(t="span".createElement(m).appendTo(this._container)),l.type===e.types.class){let s=()=>{this._current=t.show(),e.showView(l,t),l.uriHash=d};if(l.uriHash!==d||l.instance._options.disableCaching){let a;l.instance.change?a=l.instance.change({params:r,element:t}):l.instance._options.callRenderOnlyOnce||(a=l.instance.render({params:r,element:t}));let h=a=>{"function"==typeof a||a instanceof Array?(a=i.parse(...a)).then(i=>{"string"==typeof i?t.html(i).show():t.html("").append(i).show(),e.moduleRendered(l.instance,{params:r,element:t},!1),n(t,data.instance._options),s()}):("string"==typeof a||a instanceof HTMLElement)&&("string"==typeof a?t.html(a).show():t.html("").append(a).show(),e.moduleRendered(l.instance,{params:r,element:t},!1),n(t,data.instance._options),s())};return"function"==typeof a&&(a=i.parse(a)),a instanceof Array&&(a=i.parse(...a)),a instanceof Promise?a.then(e=>(h(e),o(t.id))):(h(a),o(t.id))}return s(),o(t.id)}return p("unknown type")}t({id:s,view:a,params:r,uri:h,elementOrId:m}).then(t=>(this._views[s]=t.data,this._container.append(t.element),this._current=t.element,e.showView(t.data,t.element),o(t.element.id)))})}}));