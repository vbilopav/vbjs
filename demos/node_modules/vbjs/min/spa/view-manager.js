define(["sys/view-manager/utils","sys/view-manager/reveal","sys/app"],(e,{reveal:t,revealComponents:n},i)=>(class{constructor(e=(()=>{throw e})()){this._container=e,this._views={},this._current}leave(e){if(void 0===e)return this;let t=this._views[e];return t?(t.x=window.pageXOffset,t.y=window.pageYOffset,this):this}async reveal({id:a="",view:s=(()=>{throw s})(),params:r={},uri:h=""}){r=await e.prepareParams(r),await new Promise((o,p)=>{let l=this._views[a],d=h.hashCode(),m=e.getId(d);if(this._current&&this._current.hide(),l){if(l.type===e.types.string)return this._current=l.element.show(),e.showView(l,l.element),o(l.element.id);let t=this._container.find("#"+m);if(l.type===e.types.template){if(t.length||(t="span".createElement(m).appendTo(this._container)),l.uriHash!==d){let i=l.instance(r);"string"==typeof i?(t.html(i),n(t,r.template,r),e.templateRendered(r,t)):i instanceof HTMLElement?(t.html("").append(i),n(t,r.template,r),e.templateRendered(r,t)):i instanceof Promise&&i.then(i=>{"string"==typeof i?t.html(i):t.html("").append(i),n(t,r.template,r),e.templateRendered(r,t)})}return this._current=t.show(),e.showView(l,t),o(t.id)}if(t.length||(t=this._container.find("[data-id='"+a+"']")).length&&(t.id=m),t.length||(t="span".createElement(m).appendTo(this._container)),l.type===e.types.class){let a=()=>{this._current=t.show(),e.showView(l,t),l.uriHash=d};if(l.uriHash!==d||l.instance._options.disableCaching){let s;l.instance.change?s=l.instance.change({params:r,element:t}):l.instance._options.callRenderOnlyOnce||(s=l.instance.render({params:r,element:t}));let h=s=>{"function"==typeof s||s instanceof Array?(s=i.parse(...s)).then(i=>{"string"==typeof i?t.html(i).show():t.html("").append(i).show(),n(t,data.instance._options,data.instance),e.moduleRendered(l.instance,{params:r,element:t},!1),a()}):("string"==typeof s||s instanceof HTMLElement)&&("string"==typeof s?t.html(s).show():t.html("").append(s).show(),n(t,data.instance._options,data.instance),e.moduleRendered(l.instance,{params:r,element:t},!1),a())};return"function"==typeof s&&(s=i.parse(s)),s instanceof Array&&(s=i.parse(...s)),s instanceof Promise?s.then(e=>(h(e),o(t.id))):(h(s),o(t.id))}return a(),o(t.id)}return p("unknown type")}t({id:a,view:s,params:r,uri:h,elementOrId:m}).then(t=>(this._views[a]=t.data,this._container.append(t.element),this._current=t.element,e.showView(t.data,t.element),o(t.element.id)))})}}));