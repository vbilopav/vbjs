define(["sys/view-manager/utils","sys/view-manager/reveal","sys/app"],(e,n,t)=>(class{constructor(e=(()=>{throw e})()){this._container=e,this._views={},this._current}leave(e){if(void 0===e)return this;let n=this._views[e];return n?(n.x=window.pageXOffset,n.y=window.pageYOffset,this):this}async reveal({id:i="",view:s=(()=>{throw s})(),params:a={},uri:r=""}){a=await e.prepareParams(a),await new Promise((h,c)=>{let d=this._views[i],o=r.hashCode(),p=e.getId(o);if(this._current&&this._current.hide(),d){if(d.type===e.types.string)return this._current=d.element.show(),e.showView(d,d.element),h(d.element.id);let n=this._container.find("#"+p);if(d.type===e.types.template){if(n.length||(n="span".createElement(p).appendTo(this._container)),d.uriHash!==o){let e=d.instance(a);"string"==typeof e?(n.html(e),a.___rendered(n)):e instanceof HTMLElement?(n.html("").append(e),a.___rendered(n)):e instanceof Promise&&e.then(e=>{"string"==typeof e?n.html(e):n.html("").append(e),a.___rendered(n)})}return this._current=n.show(),e.showView(d,n),h(n.id)}if(n.length||(n=this._container.find("[data-id='"+i+"']")).length&&(n.id=p),n.length||(n="span".createElement(p).appendTo(this._container)),d.type===e.types.class){let i=()=>{this._current=n.show(),e.showView(d,n),d.uriHash=o};if(d.uriHash!==o||d.instance._options.disableCaching){let e;d.instance.change?e=d.instance.change({params:a,element:n}):d.instance._options.callRenderOnlyOnce||(e=d.instance.render({params:a,element:n}));let s=e=>{"function"==typeof e||e instanceof Array?(e=t.parse(...e)).then(e=>{"string"==typeof e?n.html(e).show():n.html("").append(e).show(),d.instance.changed?d.instance.changed({params:a,element:n}):d.instance.rendered&&d.instance.rendered({params:a,element:n}),i()}):("string"==typeof e||e instanceof HTMLElement)&&("string"==typeof e?n.html(e).show():n.html("").append(e).show(),d.instance.changed?d.instance.changed({params:a,element:n}):d.instance.rendered&&d.instance.rendered({params:a,element:n}),i())};return"function"==typeof e&&(e=t.parse(e)),e instanceof Array&&(e=t.parse(...e)),e instanceof Promise?e.then(e=>(s(e),h(n.id))):(s(e),h(n.id))}return i(),h(n.id)}return c("unknown type")}n({id:i,view:s,params:a,uri:r,elementOrId:p}).then(n=>(this._views[i]=n.data,this._container.append(n.element),this._current=n.element,e.showView(n.data,n.element),h(n.element.id)))})}}));