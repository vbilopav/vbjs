define(["sys/view-manager/utils","sys/view-manager/reveal","sys/app"],(e,t,n)=>(class{constructor(e=(()=>{throw e})()){this._container=e,this._views={},this._current}leave(e){if(void 0===e)return this;let t=this._views[e];return t?(t.x=window.pageXOffset,t.y=window.pageYOffset,this):this}async reveal({id:i="",view:s=(()=>{throw s})(),params:a={},uri:r=""}){a=await e.prepareParams(a),await new Promise((h,o)=>{let l=this._views[i],p=r.hashCode(),d=e.getId(p);if(this._current&&this._current.hide(),l){if(l.type===e.types.string)return this._current=l.element.show(),e.showView(l,l.element),h(l.element.id);let t=this._container.find("#"+d);if(l.type===e.types.template){if(t.length||(t="span".createElement(d).appendTo(this._container)),l.uriHash!==p){let n=l.instance(a);"string"==typeof n?(t.html(n),e.templateRendered(a,t)):n instanceof HTMLElement?(t.html("").append(n),e.templateRendered(a,t)):n instanceof Promise&&n.then(n=>{"string"==typeof n?t.html(n):t.html("").append(n),e.templateRendered(a,t)})}return this._current=t.show(),e.showView(l,t),h(t.id)}if(t.length||(t=this._container.find("[data-id='"+i+"']")).length&&(t.id=d),t.length||(t="span".createElement(d).appendTo(this._container)),l.type===e.types.class){let i=()=>{this._current=t.show(),e.showView(l,t),l.uriHash=p};if(l.uriHash!==p||l.instance._options.disableCaching){let s;l.instance.change?s=l.instance.change({params:a,element:t}):l.instance._options.callRenderOnlyOnce||(s=l.instance.render({params:a,element:t}));let r=s=>{"function"==typeof s||s instanceof Array?(s=n.parse(...s)).then(n=>{"string"==typeof n?t.html(n).show():t.html("").append(n).show(),e.moduleRendered(l.instance,{params:a,element:t},!1),i()}):("string"==typeof s||s instanceof HTMLElement)&&("string"==typeof s?t.html(s).show():t.html("").append(s).show(),e.moduleRendered(l.instance,{params:a,element:t},!1),i())};return"function"==typeof s&&(s=n.parse(s)),s instanceof Array&&(s=n.parse(...s)),s instanceof Promise?s.then(e=>(r(e),h(t.id))):(r(s),h(t.id))}return i(),h(t.id)}return o("unknown type")}t({id:i,view:s,params:a,uri:r,elementOrId:d}).then(t=>(this._views[i]=t.data,this._container.append(t.element),this._current=t.element,e.showView(t.data,t.element),h(t.element.id)))})}}));