define(["sys/view-manager/utils","sys/app","sys/template/helpers","sys/view-manager/components"],(e,t,n,{getEntry:s})=>{const r=(e,t,n)=>{if(!t.includes(e.nodeName))return;const r=s(e.nodeName);if(!r)return;found=!0;const a={},i=r.wrap.createElement();for(let t=0,n=e.attributes.length;t<n;t++){let n=e.attributes[t];a[n.name.toCamelCase()]=n.value}if(a.html=e.html(),e.parentElement.insertBefore(i,e),e.remove(),n){a.___owner=n;let e=a.name||a.id;e&&((n=n.template||n).children=n.children||{},n.children[e.toCamelCase()]=a)}return{view:r.src,elementOrId:i,params:a}},a=(e,t,n)=>{let s=t.components;if(!s||!s.length)return;const a=[];e.forEachChild(e=>{let t=r(e,s,n);t&&a.push(t)});const l=new MutationObserver(e=>{for(let t of e)if(t.addedNodes&&t.addedNodes.length)for(let e of t.addedNodes){let t=r(e,s,n);t&&i(t)}}),o={attributes:!1,childList:!0,subtree:!0};return a.length?Promise.all(a.map(e=>i(e))).then(t=>{l.observe(e,o)}):l.observe(e,o),l},i=({id:s="",view:r=(()=>{throw r})(),params:i={},uri:l="",elementOrId:o=(()=>{throw o})()})=>new Promise(m=>{let p,d;if("string"==typeof r?(p=r,d=[r]):"object"==typeof r&&(p=r.name,d=r.inject?[p].concat(r.inject):[p]),!p||!d)throw new Error("View definition incorrect!");require(d,(r,...d)=>{let c=l.hashCode(),f=e.getViewType(r,p),h="string"==typeof o?"span".createElement(o):o,u={type:f,uriHash:c,x:0,y:0,id:s};if(s&&(h.dataset.id=s),f===e.types.string)u.element=h.html(r);else if(f===e.types.template){u.instance=r;let t=r(i,{injected:d});"string"==typeof t?(h.html(t),a(h,i.template,i),e.templateRendered(i,h)):t instanceof HTMLElement?(h.html("").append(t),a(h,i.template,i),e.templateRendered(i,h)):t instanceof Promise&&t.then(t=>{"string"==typeof t?h.html(t):h.html("").append(t),a(h,i.template,i),e.templateRendered(i,h)})}else if(f===e.types.class){let t={disableCaching:!1,callRenderOnlyOnce:!1,css:[]};e.prepareInstance(t),u.instance=new r({id:s,element:h,options:t},...d),u.instance._options=t,i.___owner&&(u.instance.parent=i.___owner,delete i.___owner),t.css&&t.css.length&&n().css.import(...t.css)}let y=n=>{"function"==typeof n||n instanceof Array?(n=t.parse(...n)).then(t=>{"string"==typeof t?h.html(t):h.html("").append(t),a(h,u.instance._options,u.instance),e.moduleRendered(u.instance,{params:i,element:h})}):("string"==typeof n||n instanceof HTMLElement)&&("string"==typeof n?h.html(n):h.html("").append(n),a(h,u.instance._options,u.instance),e.moduleRendered(u.instance,{params:i,element:h}))};if(f===e.types.class){let e=u.instance.render({params:i,element:h});return("function"==typeof e||e instanceof Array)&&(e="function"==typeof e?t.parse(e):t.parse(...e)),e instanceof Promise?e.then(e=>(y(e),m({data:u,element:h}))):(y(e),m({data:u,element:h}))}return m({data:u,element:h})})});return{reveal:i,revealComponents:a}});