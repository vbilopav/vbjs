define(["sys/view-manager/utils","sys/app","sys/view-manager/components"],(e,t,{getEntry:n,getTags:s})=>{let a=[];const r=(e,t,s)=>{if(!t.includes(e.nodeName))return;const a=n(e.nodeName);if(!a)return;const r={},i=a.wrap.createElement();for(let t=0,n=e.attributes.length;t<n;t++){let n=e.attributes[t];r[n.name.toCamelCase()]=n.value,i.setAttribute(n.name,n.value)}if(r.html=e.html(),e.parentElement.insertBefore(i,e),e.remove(),s){r.___extra=Object.assign(r.___extra||{},{parent:s});let e=r.name||r.id;e&&((s=s.template||s).children=s.children||{},s.children[e.toCamelCase()]=r)}return new MutationObserver(e=>{for(let t of e){if(!t.attributeName)continue;const e=t.attributeName.toCamelCase(),n=t.target.getAttribute(t.attributeName);r.template&&(!r.template[e]||r.template[e](n)),r.__parent&&(r.__parent[e]=n)}}).observe(i,{attributes:!0,childList:!1,subtree:!1}),{view:a.src,elementOrId:i,params:r}},i=(e,t,n)=>{let s=t.components;if(!s||!s.length)return;const a=[];e.forEachChild(e=>{let t=r(e,s,n);t&&a.push(t)});const i=new MutationObserver(e=>{for(let t of e)if(t.addedNodes&&t.addedNodes.length)for(let e of t.addedNodes){let t=r(e,s,n);i.takeRecords(),t&&o(t)}}),l={attributes:!1,childList:!0,subtree:!0};return a.length?Promise.all(a.map(e=>o(e))).then(t=>{i.observe(e,l)}):i.observe(e,l),i},o=({id:n="",view:r=(()=>{throw r})(),params:o={},uri:l="",elementOrId:c=(()=>{throw c})()})=>new Promise(p=>{let m,d;if("string"==typeof r?(m=r,d=[r]):"object"==typeof r&&(m=r.name,d=r.inject?[m].concat(r.inject):[m]),!m||!d)throw new Error("View definition incorrect!");require(d,(r,...d)=>{const f=l.hashCode(),h=e.getViewType(r,m),u="string"==typeof c?"span".createElement(c):c,y={type:h,uriHash:f,x:0,y:0,id:n};n&&(u.dataset.id=n);const _=()=>{const n=n=>{"function"==typeof n||n instanceof Array?(n=t.parse(...n)).then(e=>{"string"==typeof e?u.html(e):u.html("").appendChild(e)}):("string"==typeof n||n instanceof HTMLElement)&&("string"==typeof n?u.html(n):u.html("").appendChild(n)),i(u,y.instance._options,y.instance),e.moduleRendered(y.instance,{params:o,element:u})};if(h===e.types.class){let e=y.instance.render({params:o,element:u});return("function"==typeof e||e instanceof Array)&&(e="function"==typeof e?t.parse(e):t.parse(...e)),e instanceof Promise?e.then(e=>(n(e),p({data:y,element:u}))):(n(e),p({data:y,element:u}))}return p({data:y,element:u})};if(h===e.types.string)return y.element=u.html(r),_();if(h===e.types.template){y.instance=r,o.___extra=Object.assign(o.___extra||{},{components:null,watch:(...e)=>{e&&e.length||(e=s()),o.template.components=e.map(e=>e.toUpperCase())}});const t=r(o,{injected:d});return"string"==typeof t?(u.html(t),i(u,o.template,o),e.templateRendered(o,u)):t instanceof HTMLElement?(u.html("").appendChild(t),i(u,o.template,o),e.templateRendered(o,u)):t instanceof Promise&&t.then(t=>{"string"==typeof t?u.html(t):u.html("").appendChild(t),i(u,o.template,o),e.templateRendered(o,u)}),_()}if(h===e.types.class){const e={disableCaching:!1,callRenderOnlyOnce:!1,css:[],components:null,watch:(...t)=>{t&&t.length||(t=s()),e.components=t.map(e=>e.toUpperCase())}};if(y.instance=new r({id:n,element:u,options:e},...d),y.instance._options=e,o.__parent=y.instance,o.___extra){for(let[e,t]of Object.entries(o.___extra))y.instance[e]=t;delete o.___extra}if(e.css&&"string"==typeof e.css&&(e.css=[e.css]),e.css&&e.css.length&&(e.css=e.css.filter(e=>!a.includes(e))),!e.css||!e.css.length)return _();require(e.css.map(e=>e.startsWith("text!")?e:"text!"+e),(...e)=>(document.head.appendChild(`<style type="text/css">\n                                    ${e.join("")}\n                                </style>`.toHTML()),_())),a=e.css.concat(a)}})});return{reveal:o,revealComponents:i}});