define(["sys/view-manager/utils","sys/view-manager/reveal","sys/app"],(e,{reveal:t,revealComponents:n},i)=>(class{constructor(e=(()=>{throw e})()){this._container=e,this._views={},this._current}leave(e){if(void 0===e)return this;let t=this._views[e];return t?(t.x=window.pageXOffset,t.y=window.pageYOffset,this):this}async reveal({id:a="",view:s=(()=>{throw s})(),params:r={},uri:o=""}){r instanceof Promise&&(r=await r),"object"!=typeof r&&(r={value:r}),await new Promise((h,l)=>{let p=this._views[a],d=o.hashCode(),c=e.getId(d);if(this._current&&this._current.hide(),p){if(p.type===e.types.string)return this._current=p.element.show(),e.showView(p,p.element),h(p.element.id);let t=this._container.find("#"+c);if(p.type===e.types.template){if(t.length||(t="span".createElement(c).appendTo(this._container)),p.uriHash!==d){let i=p.instance(r);"string"==typeof i?(t.html(i),n(t,r.template,r),e.templateRendered(r,t)):i instanceof HTMLElement?(t.html("").append(i),n(t,r.template,r),e.templateRendered(r,t)):i instanceof Promise&&i.then(i=>{"string"==typeof i?t.html(i):t.html("").append(i),n(t,r.template,r),e.templateRendered(r,t)})}return this._current=t.show(),e.showView(p,t),h(t.id)}if(t.length||(t=this._container.find("[data-id='"+a+"']")).length&&(t.id=c),t.length||(t="span".createElement(c).appendTo(this._container)),p.type===e.types.class){let a=()=>{this._current=t.show(),e.showView(p,t),p.uriHash=d};if(p.uriHash!==d||p.instance._options.disableCaching){let s;p.instance.change?s=p.instance.change({params:r,element:t}):p.instance._options.callRenderOnlyOnce||(s=p.instance.render({params:r,element:t}));let o=s=>{"function"==typeof s||s instanceof Array?(s=i.parse(...s)).then(i=>{"string"==typeof i?t.html(i).show():t.html("").append(i).show(),n(t,data.instance._options,data.instance),e.moduleRendered(p.instance,{params:r,element:t},!1),a()}):("string"==typeof s||s instanceof HTMLElement)&&("string"==typeof s?t.html(s).show():t.html("").append(s).show(),n(t,data.instance._options,data.instance),e.moduleRendered(p.instance,{params:r,element:t},!1),a())};return"function"==typeof s&&(s=i.parse(s)),s instanceof Array&&(s=i.parse(...s)),s instanceof Promise?s.then(e=>(o(e),h(t.id))):(o(s),h(t.id))}return a(),h(t.id)}return l("unknown type")}t({id:a,view:s,params:r,uri:o,elementOrId:c}).then(t=>(this._views[a]=t.data,this._container.append(t.element),this._current=t.element,e.showView(t.data,t.element),h(t.element.id)))})}}));