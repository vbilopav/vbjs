define(["sys/view-manager/utils","sys/view-manager/reveal","sys/app"],(e,{reveal:t,revealComponents:n},i)=>(class{constructor(e=(()=>{throw e})()){this._container=e,this._views={},this._current}leave(e){if(void 0===e)return this;let t=this._views[e];return t?(t.x=window.pageXOffset,t.y=window.pageYOffset,this):this}async reveal({id:s="",view:a=(()=>{throw a})(),params:r={},uri:h=""}){r instanceof Promise&&(r=await r),"object"!=typeof r&&(r={value:r}),await new Promise((l,o)=>{let p=this._views[s],d=h.hashCode(),c=e.getId(d);if(this._current&&this._current.hide(),p){if(p.type===e.types.string)return this._current=p.element.show(),e.showView(p,p.element),l(p.element.id);let t=this._container.find("#"+c);if(p.type===e.types.template){if(t.length||(t="span".createElement(c),this._container.appendChild(t)),p.uriHash!==d){let i=p.instance(r);"string"==typeof i?(t.html(i),n(t,r.template,r),e.templateRendered(r,t)):i instanceof HTMLElement?(t.html("").appendChild(i),n(t,r.template,r),e.templateRendered(r,t)):i instanceof Promise&&i.then(i=>{"string"==typeof i?t.html(i):t.html("").appendChild(i),n(t,r.template,r),e.templateRendered(r,t)})}return this._current=t.show(),e.showView(p,t),l(t.id)}if(t.length||(t=this._container.find("[data-id='"+s+"']")).length&&(t.id=c),t.length||(t="span".createElement(c),this._container.appendChild(t)),p.type===e.types.class){let s=()=>{this._current=t.show(),e.showView(p,t),p.uriHash=d};if(p.uriHash!==d||p.instance._options.disableCaching){let a;p.instance.change?a=p.instance.change({params:r,element:t}):p.instance._options.callRenderOnlyOnce||(a=p.instance.render({params:r,element:t}));let h=a=>{"function"==typeof a||a instanceof Array?(a=i.parse(...a)).then(e=>{"string"==typeof e?t.html(e).show():(t.html("").appendChild(e),t.show())}):("string"==typeof a||a instanceof HTMLElement)&&("string"==typeof a?t.html(a).show():(t.html("").element(a),t.show())),n(t,p.instance._options,p.instance),e.moduleRendered(p.instance,{params:r,element:t},!1),s()};return"function"==typeof a&&(a=i.parse(a)),a instanceof Array&&(a=i.parse(...a)),a instanceof Promise?a.then(e=>(h(e),l(t.id))):(h(a),l(t.id))}return s(),l(t.id)}return o("unknown type")}t({id:s,view:a,params:r,uri:h,elementOrId:c}).then(t=>(this._views[s]=t.data,this._container.appendChild(t.element),this._current=t.element,e.showView(t.data,t.element),l(t.element.id)))})}}));