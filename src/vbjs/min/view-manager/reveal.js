define(["sys/view-manager/utils","sys/app"],(e,t)=>{const n=(e,t,n)=>{if(!t.includes(e.nodeName))return;const r=_app._components[e.nodeName];if(!r)return;found=!0;const a={},s=r.wrap.createElement();for(let t=0,n=e.attributes.length;t<n;t++){let n=e.attributes[t];a[n.name.toCamelCase()]=n.value}return a.html=e.html(),e.parentElement.insertBefore(s,e),e.remove(),n&&(a.___owner=n),{view:r.src,elementOrId:s,params:a}},r=(e,t,r)=>{let s=t.components;if(!s||!s.length)return;const i=[];e.forEachChild(e=>{let t=n(e,s,r);t&&i.push(t)});const o=new MutationObserver(e=>{for(let t of e)if(t.addedNodes&&t.addedNodes.length)for(let e of t.addedNodes){let t=n(e,s,r);t&&a(t)}}),l={attributes:!1,childList:!0,subtree:!0};return i.length?Promise.all(i.map(e=>a(e))).then(t=>{o.observe(e,l)}):o.observe(e,l),o},a=({id:n="",view:a=(()=>{throw a})(),params:s={},uri:i="",elementOrId:o=(()=>{throw o})()})=>new Promise(l=>{let p,m;if("string"==typeof a?(p=a,m=[a]):"object"==typeof a&&(p=a.name,m=a.inject?[p].concat(a.inject):[p]),!p||!m)throw new Error("View definition incorrect!");require(m,(a,...m)=>{let d=i.hashCode(),c=e.getViewType(a,p),f="string"==typeof o?"span".createElement(o):o,h={type:c,uriHash:d,x:0,y:0,id:n};if(n&&(f.dataset.id=n),c===e.types.string)h.element=f.html(a);else if(c===e.types.template){h.instance=a;let t=a(s,{injected:m});"string"==typeof t?(f.html(t),e.templateRendered(s,f),r(f,s.template,s)):t instanceof HTMLElement?(f.html("").append(t),e.templateRendered(s,f),r(f,s.template,s)):t instanceof Promise&&t.then(t=>{"string"==typeof t?f.html(t):f.html("").append(t),e.templateRendered(s,f),r(f,s.template,s)})}else if(c===e.types.class){let t={disableCaching:!1,callRenderOnlyOnce:!1};e.prepareInstance(t),h.instance=new a({id:n,element:f,options:t},...m),h.instance._options=t}let u=n=>{"function"==typeof n||n instanceof Array?(n=t.parse(...n)).then(t=>{"string"==typeof t?f.html(t):f.html("").append(t),e.moduleRendered(h.instance,{params:s,element:f}),r(f,h.instance._options)}):("string"==typeof n||n instanceof HTMLElement)&&("string"==typeof n?f.html(n):f.html("").append(n),e.moduleRendered(h.instance,{params:s,element:f}),r(f,h.instance._options))};if(c===e.types.class){let e=h.instance.render({params:s,element:f});return("function"==typeof e||e instanceof Array)&&(e="function"==typeof e?t.parse(e):t.parse(...e)),e instanceof Promise?e.then(e=>(u(e),l({data:h,element:f}))):(u(e),l({data:h,element:f}))}return l({data:h,element:f})})});return{reveal:a,revealComponents:r}});